name: Treinar Modelo com Heuristicas Dinamicas

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * 1'

jobs:
  train_model:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: pip install numpy scikit-learn scipy joblib

      - name: Verificar Import Correto
        run: |
          echo "=== VERIFICANDO IMPORT NO treinar_decisor_1.py ==="
          if grep -q "from lib.despachante import Despachante" treinar_decisor_1.py; then
            echo "❌ IMPORT ERRADO: usando lib.despachante em vez de lib.despachante_new"
            echo "✅ CORRIJA: mude para 'from lib.despachante_new import Despachante'"
            exit 1
          else
            echo "✅ IMPORT CORRETO"
          fi

      - name: Executar Treino
        run: |
          PYTHONPATH=. python treinar_decisor_1.py --num-dinamicas 25

      - name: Verificar Resultados
        run: |
          if [ -f "decisor/metadados_modelo.json" ]; then
            echo "✅ Treino concluído com sucesso"
          else
            echo "❌ Treino falhou - verifique os logs acima"
            exit 1
          fi

      - name: Commitar Modelos
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add decisor/ && git commit -m "Update models [bot]" && git push || echo "Nada para commitar"

      - name: Relatório
        if: always()
        run: |
          echo "RELATORIO" > $GITHUB_STEP_SUMMARY
          if [ -f "decisor/metadados_modelo.json" ]; then
            echo "✅ SUCESSO" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ FALHA - Verifique o import no treinar_decisor_1.py" >> $GITHUB_STEP_SUMMARY
          fi
