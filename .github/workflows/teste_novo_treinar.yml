name: Treinar e Salvar Modelo com HeurÃ­sticas DinÃ¢micas 2

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * 1'  # Toda segunda-feira Ã s 08:00 UTC

jobs:
  train_dynamic_model:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout do RepositÃ³rio
        uses: actions/checkout@v4

      - name: ðŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ðŸ“¦ Instalar DependÃªncias
        run: |
          python -m pip install --upgrade pip
          # Criar requirements.txt se nÃ£o existir
          if [ ! -f "requirements.txt" ]; then
            echo "ðŸ”§ Criando requirements.txt bÃ¡sico..."
            cat > requirements.txt << EOF
numpy>=1.21.0
scikit-learn>=1.0.0
scipy>=1.7.0
joblib>=1.1.0
EOF
          fi
          pip install -r requirements.txt

      - name: ðŸ” Verificar Ambiente com Check Script
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python check_environment.py
          
      - name: ðŸ§ª Testar IntegraÃ§Ã£o DinÃ¢mica
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "ðŸ§ª TESTANDO HEURÃSTICAS DINÃ‚MICAS..."
          python -c "
import sys
import os
sys.path.insert(0, os.getcwd())

try:
    print('1. ðŸ“¥ Importando mÃ³dulos...')
    from lib.dados import Dados
    from lib.despachante_new import Despachante
    from lib.GeradorHeuristicasDinamicas import GeradorHeuristicasDinamicas
    
    print('2. ðŸŽ¯ Criando despachante com dinÃ¢micas...')
    despachante = Despachante(usar_dinamicas=True)
    
    print('3. ðŸ“Š Verificando heurÃ­sticas carregadas...')
    metadados = despachante.obter_metadados()
    total = len(metadados)
    dinamicas = [h for h, meta in metadados.items() if meta.get('tipo') == 'dinamica']
    fixas = [h for h, meta in metadados.items() if meta.get('tipo') == 'fixa']
    
    print(f'   âœ… Total: {total} heurÃ­sticas')
    print(f'   ðŸ”§ Fixas: {len(fixas)}')
    print(f'   ðŸ§  DinÃ¢micas: {len(dinamicas)}')
    
    if len(dinamicas) > 0:
        print('4. ðŸŽ¯ Testando previsÃµes...')
        dados = Dados()
        deps = despachante.obter_todas_dependencias()
        stats, _ = dados.obter_estatisticas(deps)
        previsoes = despachante.get_previsoes(stats, n=5)
        
        print(f'   âœ… PrevisÃµes: {len(previsoes)} heurÃ­sticas')
        print('ðŸŽ‰ SISTEMA DINÃ‚MICO FUNCIONANDO!')
    else:
        print('âŒ Nenhuma heurÃ­stica dinÃ¢mica carregada')
        sys.exit(1)
        
except Exception as e:
    print(f'âŒ ERRO: {e}')
    import traceback
    traceback.print_exc()
    sys.exit(1)
"

      - name: ðŸ§  Executar Treino com HeurÃ­sticas DinÃ¢micas
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "ðŸš€ Iniciando treino com heurÃ­sticas dinÃ¢micas..."
          python treinar_decisor1.py --num-dinamicas 25
          
      - name: ðŸ“Š Executar AvaliaÃ§Ã£o do Sistema
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "ðŸ“ˆ Executando avaliaÃ§Ã£o do sistema..."
          python avaliador/avaliador1.py --manutencao
          
      - name: âœ… Verificar Resultados do Treino
        run: |
          echo "ðŸ” Verificando ficheiros gerados:"
          
          # Verificar modelos
          if [ -d "decisor/modelos_salvos" ]; then
            echo "âœ… Pasta de modelos encontrada"
            echo "ðŸ“Š ConteÃºdo:"
            ls -la decisor/modelos_salvos/ | head -10
            
            # Verificar se hÃ¡ modelos treinados
            MODEL_COUNT=$(find decisor/modelos_salvos/ -name "*.joblib" | wc -l)
            echo "ðŸ“ˆ Modelos treinados: $MODEL_COUNT"
          else
            echo "âŒ Pasta de modelos nÃ£o encontrada"
            exit 1
          fi
          
          # Verificar metadados
          if [ -f "decisor/metadados_modelo.json" ]; then
            echo "âœ… Metadados encontrados"
            echo "ðŸ“ˆ EstatÃ­sticas do sistema:"
            python -c "
import json
try:
    with open('decisor/metadados_modelo.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    stats = data.get('estatisticas_sistema', {})
    config = data.get('configuracao', {})
    
    print(f'HeurÃ­sticas totais: {stats.get(\\\"total_heuristicas\\\", 0)}')
    print(f'HeurÃ­sticas fixas: {stats.get(\\\"heuristicas_fixas\\\", 0)}') 
    print(f'HeurÃ­sticas dinÃ¢micas: {stats.get(\\\"heuristicas_dinamicas\\\", 0)}')
    print(f'Dataset: {config.get(\\\"dimensoes_dataset\\\", \\\"N/A\\\")}')
    print(f'Sorteios: {config.get(\\\"sorteios_processados\\\", 0)}')
    
    # Verificar se usou dinÃ¢micas
    if stats.get(\\\"heuristicas_dinamicas\\\", 0) > 0:
        print('âœ… HeurÃ­sticas dinÃ¢micas: ATIVAS')
    else:
        print('âŒ HeurÃ­sticas dinÃ¢micas: INATIVAS')
    
except Exception as e:
    print(f'Erro: {e}')
"
          else
            echo "âŒ Metadados nÃ£o encontrados"
            exit 1
          fi
      
      - name: ðŸ’¾ Commitar e Enviar Modelos Atualizados
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Adicionar ficheiros gerados
          git add decisor/modelos_salvos/
          git add decisor/metadados_modelo.json
          git add decisor/configuracao_despachante.json 2>/dev/null || echo "âš ï¸ ConfiguraÃ§Ã£o nÃ£o encontrada"
          git add decisor/historico_otimizacao.json 2>/dev/null || echo "âš ï¸ HistÃ³rico nÃ£o encontrado"
          
          # Commitar se houver alteraÃ§Ãµes
          if git diff --staged --quiet; then
            echo "ðŸ“ Nenhuma alteraÃ§Ã£o para commitar"
          else
            echo "ðŸš€ Comitando modelos atualizados..."
            git commit -m "feat: Atualiza modelo com heurÃ­sticas dinÃ¢micas [bot]"
            git push
            echo "âœ… Modelos atualizados com sucesso!"
          fi
          
      - name: ðŸ“‹ Gerar RelatÃ³rio de ExecuÃ§Ã£o
        if: always()
        run: |
          echo "ðŸ“‹ RELATÃ“RIO DE EXECUÃ‡ÃƒO" >> $GITHUB_STEP_SUMMARY
          echo "==========================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # RelatÃ³rio detalhado
          python -c "
import json, os, datetime

print('## ðŸ”§ Status do Pipeline de HeurÃ­sticas DinÃ¢micas')
print('')

# Verificar metadados
if os.path.exists('decisor/metadados_modelo.json'):
    try:
        with open('decisor/metadados_modelo.json', 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        stats = data.get('estatisticas_sistema', {})
        config = data.get('configuracao', {})
        
        print('### ðŸ“Š EstatÃ­sticas do Sistema')
        print(f'- **HeurÃ­sticas totais:** {stats.get(\\\"total_heuristicas\\\", 0)}')
        print(f'- **HeurÃ­sticas fixas:** {stats.get(\\\"heuristicas_fixas\\\", 0)}')
        print(f'- **HeurÃ­sticas dinÃ¢micas:** {stats.get(\\\"heuristicas_dinamicas\\\", 0)}')
        print(f'- **DimensÃµes do dataset:** {config.get(\\\"dimensoes_dataset\\\", \\\"N/A\\\")}')
        print(f'- **Sorteios processados:** {config.get(\\\"sorteios_processados\\\", 0)}')
        print(f'- **Data do treino:** {data.get(\\\"data_treino\\\", \\\"N/A\\\")}')
        
        # Contar modelos
        modelos = [f for f in os.listdir('decisor/modelos_salvos/') if f.endswith('.joblib')]
        print(f'- **Modelos treinados:** {len(modelos)}')
        
        # Status das dinÃ¢micas
        if stats.get(\\\"heuristicas_dinamicas\\\", 0) > 0:
            print('- **ðŸ”§ HeurÃ­sticas dinÃ¢micas:** âœ… Ativas e funcionando')
            print('ðŸŽ‰ **Pipeline dinÃ¢mico operacional!**')
        else:
            print('- **ðŸ”§ HeurÃ­sticas dinÃ¢micas:** âŒ NÃ£o carregadas')
            print('âš ï¸ **Sistema usando apenas heurÃ­sticas fixas**')
            
    except Exception as e:
        print(f'âŒ **Erro ao ler metadados:** {e}')
else:
    print('âŒ **Falha no treino**')
    print('Os metadados do modelo nÃ£o foram gerados.')
    print('')
    print('### ðŸ” PossÃ­veis causas:')
    print('- Erro no carregamento das heurÃ­sticas dinÃ¢micas')
    print('- Problema nos dados de treino') 
    print('- Falha na geraÃ§Ã£o de features')

print('')
print(f'â° **Executado em:** {datetime.datetime.now().strftime(\\\"%Y-%m-%d %H:%M:%S\\\")}')
" >> $GITHUB_STEP_SUMMARY
