name: Treinar e Salvar Modelo com HeurÃ­sticas DinÃ¢micas

on:
  workflow_dispatch:
  schedule:
    # Executa automaticamente toda segunda-feira Ã s 08:00 UTC
    - cron: '0 8 * * 1'

jobs:
  train_dynamic_model:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout do RepositÃ³rio
        uses: actions/checkout@v4

      - name: ðŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: ðŸ“¦ Instalar DependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Instala dependÃªncias adicionais para heurÃ­sticas dinÃ¢micas
          pip install numpy scikit-learn scipy
          
      - name: ðŸ”§ Verificar Estrutura de Ficheiros
        run: |
          echo "ðŸ“ Estrutura do projeto:"
          find . -name "*.py" -path "*/lib/*" -o -name "*.py" -path "*/decisor/*" -o -name "*.py" -path "*/avaliador/*" | head -20
          echo ""
          echo "âœ… Ficheiros necessÃ¡rios:"
          ls -la lib/ | grep -E "(dados|despachante|gerador).py" || echo "âš ï¸  Alguns ficheiros podem estar faltando"

      - name: ðŸ” Verificar Ambiente
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python check_environment.py 
      
      - name: ðŸ§  Executar Treino com HeurÃ­sticas DinÃ¢micas
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "ðŸš€ Iniciando treino com heurÃ­sticas dinÃ¢micas..."
          python treinar_decisor1.py --num-dinamicas 25
          
      - name: ðŸ“Š Executar AvaliaÃ§Ã£o do Sistema
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "ðŸ“ˆ Executando avaliaÃ§Ã£o do sistema..."
          python avaliador/avaliador1.py --manutencao
          
      - name: âœ… Verificar Resultados do Treino
        run: |
          echo "ðŸ” Verificando ficheiros gerados:"
          if [ -d "decisor/modelos_salvos" ]; then
            echo "âœ… Pasta de modelos encontrada"
            ls -la decisor/modelos_salvos/ | head -10
          else
            echo "âŒ Pasta de modelos nÃ£o encontrada"
            exit 1
          fi
          
          if [ -f "decisor/metadados_modelo.json" ]; then
            echo "âœ… Metadados encontrados"
            echo "ðŸ“Š EstatÃ­sticas do sistema:"
            python -c "
import json
try:
    with open('decisor/metadados_modelo.json', 'r') as f:
        data = json.load(f)
    stats = data.get('estatisticas_sistema', {})
    print(f'HeurÃ­sticas: {stats.get(\\\"total_heuristicas\\\", 0)} ({stats.get(\\\"heuristicas_fixas\\\", 0)}F + {stats.get(\\\"heuristicas_dinamicas\\\", 0)}D)')
    print(f'Dataset: {data.get(\\\"configuracao\\\", {}).get(\\\"dimensoes_dataset\\\", \\\"N/A\\\")}')
except Exception as e:
    print(f'Erro ao ler metadados: {e}')
"
          else
            echo "âŒ Metadados nÃ£o encontrados"
            exit 1
          fi
      
      - name: ðŸ’¾ Commitar e Enviar Modelos Atualizados
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Adiciona todos os ficheiros novos do sistema dinÃ¢mico
          git add decisor/modelos_salvos/
          git add decisor/metadados_modelo.json
          git add decisor/configuracao_despachante.json 2>/dev/null || echo "âš ï¸ ConfiguraÃ§Ã£o do despachante nÃ£o encontrada"
          git add decisor/historico_otimizacao.json 2>/dev/null || echo "âš ï¸ HistÃ³rico de otimizaÃ§Ã£o nÃ£o encontrado"
          
          # Verifica se hÃ¡ alteraÃ§Ãµes
          if git diff --staged --quiet; then
            echo "ðŸ“ Nenhuma alteraÃ§Ã£o nos modelos. Nenhuma aÃ§Ã£o necessÃ¡ria."
          else
            echo "ðŸš€ Comitando e enviando modelos atualizados..."
            git commit -m "feat(decisor): Atualiza modelo com heurÃ­sticas dinÃ¢micas [bot]"
            git push
            echo "âœ… Modelos atualizados com sucesso!"
          fi
          
      - name: ðŸ“‹ Gerar RelatÃ³rio de ExecuÃ§Ã£o
        if: always()
        run: |
          echo "ðŸ“‹ RELATÃ“RIO DE EXECUÃ‡ÃƒO" >> $GITHUB_STEP_SUMMARY
          echo "==========================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "decisor/metadados_modelo.json" ]; then
            echo "âœ… **Treino concluÃ­do com sucesso**" >> $GITHUB_STEP_SUMMARY
            python -c "
import json, datetime
try:
    with open('decisor/metadados_modelo.json', 'r') as f:
        data = json.load(f)
    
    stats = data.get('estatisticas_sistema', {})
    config = data.get('configuracao', {})
    
    print('## ðŸ“Š EstatÃ­sticas do Sistema')
    print(f'- **HeurÃ­sticas totais:** {stats.get(\\\"total_heuristicas\\\", 0)}')
    print(f'- **HeurÃ­sticas fixas:** {stats.get(\\\"heuristicas_fixas\\\", 0)}')
    print(f'- **HeurÃ­sticas dinÃ¢micas:** {stats.get(\\\"heuristicas_dinamicas\\\", 0)}')
    print(f'- **DimensÃµes do dataset:** {config.get(\\\"dimensoes_dataset\\\", \\\"N/A\\\")}')
    print(f'- **Sorteios processados:** {config.get(\\\"sorteios_processados\\\", 0)}')
    print(f'- **Data do treino:** {data.get(\\\"data_treino\\\", \\\"N/A\\\")}')
    
    # Verificar modelos
    import os
    modelos = [f for f in os.listdir('decisor/modelos_salvos/') if f.endswith('.joblib')]
    print(f'- **Modelos treinados:** {len(modelos)}')
    
except Exception as e:
    print(f'âŒ **Erro ao gerar relatÃ³rio:** {e}')
" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Falha no treino**" >> $GITHUB_STEP_SUMMARY
            echo "Os metadados do modelo nÃ£o foram gerados." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â° **Executado em:** $(date)" >> $GITHUB_STEP_SUMMARY
