name: Gerar Pipeline Completo de Wrappers

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Motivo para execuÃ§Ã£o manual do pipeline completo'
        required: false
        default: 'AtualizaÃ§Ã£o automÃ¡tica do sistema de wrappers'
  push:
    branches: [ main ]
    paths:
      - 'lib/funcoes_analiticas/**'
      - 'scripts/gerar_wrappers_funcoes.py'
      - 'scripts/analisador_funcoes.py'

jobs:
  executar_pipeline_completo:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout RepositÃ³rio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Instalar DependÃªncias
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install numpy pandas scipy sympy matplotlib networkx scikit-learn
          
      - name: Executar Analisador de FunÃ§Ãµes
        run: |
          echo "ðŸ“‹ Executando analisador_funcoes.py..."
          python scripts/analisador_funcoes.py
          
      - name: Executar Atualizador de Categorias
        run: |
          echo "ðŸ”§ Executando atualizador_categorias.py..."
          python scripts/atualizador_categorias.py
          
      - name: Executar Gerador de Wrappers
        run: |
          echo "ðŸ—ï¸ Executando gerar_wrappers_funcoes.py..."
          python scripts/gerar_wrappers_funcoes.py
          
      - name: Executar Gerador de UniversalWrapper
        run: |
          echo "ðŸŒ Executando gerar_universal_wrapper.py..."
          python scripts/gerar_universal_wrapper.py
          
      - name: Commit e Push das AlteraÃ§Ãµes
        run: |
          echo "ðŸ“¦ Preparando commit das alteraÃ§Ãµes..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Verificar se hÃ¡ alteraÃ§Ãµes nos wrappers gerados
          git add lib/funcoes_wrappers_auto.py
          git add lib/universal_wrapper.py
          git add relatorios/
          
          # Fazer commit apenas se houver alteraÃ§Ãµes
          if git diff --staged --quiet; then
            echo "âœ… Nenhuma alteraÃ§Ã£o detectada nos wrappers"
          else
            git commit -m "ðŸ¤– AtualizaÃ§Ã£o automÃ¡tica: wrappers gerados pelo pipeline"
            git pull origin main --rebase
            git push origin main
            echo "ðŸš€ Wrappers atualizados e enviados para o repositÃ³rio"
          fi
          
      - name: Gerar RelatÃ³rio do Pipeline
        run: |
          echo "ðŸ“Š Gerando relatÃ³rio final..."
          echo "# RelatÃ³rio do Pipeline de Wrappers" > relatorios/relatorio_pipeline.md
          echo "Data: $(date)" >> relatorios/relatorio_pipeline.md
          echo "" >> relatorios/relatorio_pipeline.md
          echo "## Arquivos Gerados:" >> relatorios/relatorio_pipeline.md
          echo "- âœ… lib/funcoes_wrappers_auto.py" >> relatorios/relatorio_pipeline.md
          echo "- âœ… lib/universal_wrapper.py" >> relatorios/relatorio_pipeline.md
          echo "- âœ… relatorios/lista_funcoes.txt" >> relatorios/relatorio_pipeline.md
          echo "- âœ… relatorios/atualizacao_categorias.txt" >> relatorios/relatorio_pipeline.md
          echo "" >> relatorios/relatorio_pipeline.md
          echo "Pipeline executado com sucesso! ðŸŽ‰" >> relatorios/relatorio_pipeline.md
