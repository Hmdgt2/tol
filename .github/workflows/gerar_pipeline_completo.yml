name: Gerar Pipeline Completo de Wrappers

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Motivo para execuÃ§Ã£o manual do pipeline completo'
        required: false
        default: 'AtualizaÃ§Ã£o automÃ¡tica do sistema de wrappers'

jobs:
  executar_pipeline_completo:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout RepositÃ³rio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Instalar DependÃªncias
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install numpy pandas scipy sympy matplotlib networkx scikit-learn
          
      # FASE 1: Analisar FunÃ§Ãµes
      - name: Executar Analisador de FunÃ§Ãµes
        id: analisador
        run: |
          echo "ðŸ“‹ Executando analisador_funcoes.py..."
          python scripts/analisador_funcoes.py
          echo "relatorios_gerados=true" >> $GITHUB_OUTPUT
          
      - name: Commit Fase 1 - RelatÃ³rio de FunÃ§Ãµes
        if: steps.analisador.outputs.relatorios_gerados == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add relatorios/lista_funcoes.txt relatorios/lista_funcoes.json
          if git diff --staged --quiet; then
            echo "âœ… Nenhuma alteraÃ§Ã£o nos relatÃ³rios de funÃ§Ãµes"
          else
            git commit -m "ðŸ¤– Fase 1: RelatÃ³rio de funÃ§Ãµes gerado"
            echo "ðŸ“Š RelatÃ³rios de funÃ§Ãµes commitados"
          fi
          
      # FASE 2: Atualizar Categorias
      - name: Executar Atualizador de Categorias
        id: atualizador
        run: |
          echo "ðŸ”§ Executando atualizador_categorias.py..."
          python scripts/atualizador_categorias.py
          echo "categorias_atualizadas=true" >> $GITHUB_OUTPUT
          
      - name: Commit Fase 2 - Categorias Atualizadas
        if: steps.atualizador.outputs.categorias_atualizadas == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add scripts/gerar_wrappers_funcoes.py relatorios/atualizacao_categorias.txt
          if git diff --staged --quiet; then
            echo "âœ… Nenhuma alteraÃ§Ã£o nas categorias"
          else
            git commit -m "ðŸ¤– Fase 2: Categorias atualizadas"
            echo "ðŸ”§ Categorias atualizadas e commitadas"
          fi
          
      # FASE 3: Gerar Wrappers
      - name: Executar Gerador de Wrappers
        id: gerador_wrappers
        run: |
          echo "ðŸ—ï¸ Executando gerar_wrappers_funcoes.py..."
          python scripts/gerar_wrappers_funcoes.py
          echo "wrappers_gerados=true" >> $GITHUB_OUTPUT
          
      - name: Commit Fase 3 - Wrappers por Categoria
        if: steps.gerador_wrappers.outputs.wrappers_gerados == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add lib/funcoes_wrappers_auto.py
          if git diff --staged --quiet; then
            echo "âœ… Nenhuma alteraÃ§Ã£o nos wrappers"
          else
            git commit -m "ðŸ¤– Fase 3: Wrappers por categoria gerados"
            echo "ðŸ—ï¸ Wrappers por categoria commitados"
          fi
          
      # FASE 4: Gerar UniversalWrapper
      - name: Executar Gerador de UniversalWrapper
        id: gerador_universal
        run: |
          echo "ðŸŒ Executando gerar_universal_wrapper.py..."
          python scripts/gerar_universal_wrapper.py
          echo "universal_wrapper_gerado=true" >> $GITHUB_OUTPUT
          
      - name: Commit Fase 4 - UniversalWrapper
        if: steps.gerador_universal.outputs.universal_wrapper_gerado == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add lib/universal_wrapper.py
          if git diff --staged --quiet; then
            echo "âœ… Nenhuma alteraÃ§Ã£o no UniversalWrapper"
          else
            git commit -m "ðŸ¤– Fase 4: UniversalWrapper gerado"
            echo "ðŸŒ UniversalWrapper commitado"
          fi
          
      # FASE FINAL: Push de todas as alteraÃ§Ãµes
      - name: Push Final de Todas as AlteraÃ§Ãµes
        run: |
          echo "ðŸ“¦ Fazendo push de todas as alteraÃ§Ãµes..."
          git pull origin main --rebase
          git push origin main
          echo "ðŸš€ Pipeline concluÃ­do com sucesso!"
          
      - name: Gerar RelatÃ³rio Final
        run: |
          echo "ðŸ“Š Gerando relatÃ³rio final do pipeline..."
          echo "# RelatÃ³rio do Pipeline de Wrappers" > relatorios/relatorio_pipeline.md
          echo "Data: $(date)" >> relatorios/relatorio_pipeline.md
          echo "" >> relatorios/relatorio_pipeline.md
          echo "## Fases Executadas:" >> relatorios/relatorio_pipeline.md
          echo "1. âœ… Analisador de FunÃ§Ãµes" >> relatorios/relatorio_pipeline.md
          echo "2. âœ… Atualizador de Categorias" >> relatorios/relatorio_pipeline.md
          echo "3. âœ… Gerador de Wrappers por Categoria" >> relatorios/relatorio_pipeline.md
          echo "4. âœ… Gerador de UniversalWrapper" >> relatorios/relatorio_pipeline.md
          echo "" >> relatorios/relatorio_pipeline.md
          echo "## Arquivos Gerados:" >> relatorios/relatorio_pipeline.md
          echo "- ðŸ“‹ relatorios/lista_funcoes.txt" >> relatorios/relatorio_pipeline.md
          echo "- ðŸ“‹ relatorios/lista_funcoes.json" >> relatorios/relatorio_pipeline.md
          echo "- ðŸ”§ relatorios/atualizacao_categorias.txt" >> relatorios/relatorio_pipeline.md
          echo "- ðŸ—ï¸ lib/funcoes_wrappers_auto.py" >> relatorios/relatorio_pipeline.md
          echo "- ðŸŒ lib/universal_wrapper.py" >> relatorios/relatorio_pipeline.md
          echo "" >> relatorios/relatorio_pipeline.md
          echo "Pipeline executado com sucesso! ðŸŽ‰" >> relatorios/relatorio_pipeline.md
