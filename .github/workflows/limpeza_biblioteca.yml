name: Limpar e Consolidar Biblioteca (Staging)

on:
  # Permite correr manualmente
  workflow_dispatch:

jobs:
  organizar_funcoes:
    runs-on: ubuntu-latest
    # PermissÃ£o necessÃ¡ria para o git-auto-commit-action fazer push de volta
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout do RepositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: ğŸ“¦ Instalar DependÃªncias NecessÃ¡rias (Incluindo astunparse)
        run: |
          python -m pip install --upgrade pip
          # Instala dependÃªncias listadas em requirements.txt e a dependÃªncia AST
          pip install -r requirements.txt astunparse
          # O ast_consolidador.py e organizador_biblioteca.py precisam de se importar
          # mutuamente; garantimos que a pasta scripts estÃ¡ no PATH
          export PYTHONPATH=$PYTHONPATH:$(pwd)/scripts

      - name: ğŸ§¹ Executar Limpeza e Staging da Biblioteca
        id: limpeza
        run: python scripts/organizador_biblioteca.py
        env:
          PYTHONPATH: ${{ github.workspace }}/scripts # Ajuste o caminho se necessÃ¡rio
        
      # O script Python jÃ¡ gerou a pasta 'lib/funcoes_limpas' e a 'backup_biblioteca_...'

      - name: ğŸ’¾ Commitar e Fazer Push dos Ficheiros Limpos e Backup
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # Alteramos o padrÃ£o para incluir a PASTA inteira e o backup.
          # Isto Ã© mais robusto do que usar o wildcard recursivo (**/*.py).
          file_pattern: 'lib/funcoes_limpas backup_biblioteca_original_*' 
          commit_message: 'âœ¨ CI: FunÃ§Ãµes consolidadas e limpas para staging (lib/funcoes_limpas)'
          branch: ${{ github.ref_name }}

      - name: â¬†ï¸ Carregar Staging como Artefacto para RevisÃ£o
        # Opcional: Permite que vocÃª baixe a pasta 'funcoes_limpas' diretamente da interface
        uses: actions/upload-artifact@v4
        with:
          name: funcoes-limpas-staging
          path: lib/funcoes_limpas/
